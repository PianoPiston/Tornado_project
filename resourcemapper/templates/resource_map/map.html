<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finland Resource Map</title>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>


    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Set map height */
        #map { height: 500px; }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-800">Finland Resource Map</h1>
            <p class="text-slate-600 mt-2">Visualizing professional and civilian-volunteered assets.</p>
        </header>

        <!-- Map Container -->
        <div id="map" class="rounded-lg shadow-lg z-0 mb-8"></div>

        <!-- Resource Tables Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Professional Resources Table -->
            <div>
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Professional Expertise</h2>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Name</th>
                                    <th scope="col" class="px-6 py-3">Profession</th>
                                    <th scope="col" class="px-6 py-3">Specialty</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for resource in professional_resources %}
                                <tr class="resource-row bg-white border-b hover:bg-slate-100 cursor-pointer transition-colors"
                                    data-id="{{ resource.pk }}"
                                    data-type="prof">
                                    <td class="px-6 py-4 font-medium text-slate-900">{{ resource.alias }}</td>
                                    <td class="px-6 py-4">{{ resource.profession }}</td>
                                    <td class="px-6 py-4">{{ resource.specialty }}</td>
                                    {% if resource.status == 'inactive' %}
                                        <td class="px-6 py-4, bg-red-600">{{ resource.status }}</td>
                                    {% else %}
                                        <td class="px-6 py-4">{{ resource.status }}</td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center p-4">No professional resources found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Civilian Resources Table -->
            <div>
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Volunteered Civilian Resources</h2>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                     <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Contact</th>
                                    <th scope="col" class="px-6 py-3">Type</th>
                                    <th scope="col" class="px-6 py-3">Description</th>
                                    <th scope="col" class="px-6 py-3">Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for resource in civilian_resources %}
                                <tr class="resource-row bg-white border-b hover:bg-slate-100 cursor-pointer transition-colors"
                                    data-id="{{ resource.pk }}"
                                    data-type="civil">
                                    <td class="px-6 py-4 font-medium text-slate-900">{{ resource.contact_person }}</td>
                                    <td class="px-6 py-4">{{ resource.get_resource_type_display }}</td>
                                    <td class="px-6 py-4">{{ resource.description }}</td>
                                    <td class="px-6 py-4">{{ resource.quantity }}</td>
                                    {% if resource.status == 'destroyed' %}
                                        <td class="px-6 py-4, bg-red-600">{{ resource.status }}</td>
                                    {% else %}
                                        <td class="px-6 py-4">{{ resource.status }}</td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center p-4">No civilian resources found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pass Django data to JavaScript -->
    {{ professional_resources_json|json_script:"professional-data" }}
    {{ civilian_resources_json|json_script:"civilian-data" }}

    <script>
        function MGRSString (Lat, Long) { 
            if (Lat < -80) return 'Too far South' ; if (Lat > 84) return 'Too far North' ;
                var c = 1 + Math.floor ((Long+180)/6);
                var e = c*6 - 183 ;
                var k = Lat*Math.PI/180;
                var l = Long*Math.PI/180;
                var m = e*Math.PI/180;
                var n = Math.cos (k);
                var o = 0.006739496819936062*Math.pow (n,2);
                var p = 40680631590769/(6356752.314*Math.sqrt(1 + o));
                var q = Math.tan (k);
                var r = q*q;
                var s = (r*r*r) - Math.pow (q,6);
                var t = l - m;
                var u = 1.0 - r + o;
                var v = 5.0 - r + 9*o + 4.0*(o*o);
                var w = 5.0 - 18.0*r + (r*r) + 14.0*o - 58.0*r*o;
                var x = 61.0 - 58.0*r + (r*r) + 270.0*o - 330.0*r*o;
                var y = 61.0 - 479.0*r + 179.0*(r*r) - (r*r*r);
                var z = 1385.0 - 3111.0*r + 543.0*(r*r) - (r*r*r);
                var aa = p*n*t + (p/6.0*Math.pow (n,3)*u*Math.pow (t,3)) + (p/120.0*Math.pow (n,5)*w*Math.pow (t,5)) + (p/5040.0*Math.pow (n,7)*y*Math.pow (t,7));
                var ab = 6367449.14570093*(k - (0.00251882794504*Math.sin (2*k)) + (0.00000264354112*Math.sin (4*k)) - (0.00000000345262*Math.sin (6*k)) + (0.000000000004892*Math.sin (8*k))) + (q/2.0*p*Math.pow (n,2)*Math.pow (t,2)) + (q/24.0*p*Math.pow (n,4)*v*Math.pow (t,4)) + (q/720.0*p*Math.pow (n,6)*x*Math.pow (t,6)) + (q/40320.0*p*Math.pow (n,8)*z*Math.pow (t,8));
                aa = aa*0.9996 + 500000.0;
                ab = ab*0.9996; if (ab < 0.0) ab += 10000000.0;
                var ad = 'CDEFGHJKLMNPQRSTUVWXX'.charAt (Math.floor (Lat/8 + 10));
                var ae = Math.floor (aa/100000);
                var af = ['ABCDEFGH','JKLMNPQR','STUVWXYZ'][(c-1)%3].charAt (ae-1);
                var ag = Math.floor (ab/100000)%20;
                var ah = ['ABCDEFGHJKLMNPQRSTUV','FGHJKLMNPQRSTUVABCDE'][(c-1)%2].charAt (ag);
                function pad (val) {if (val < 10) {val = '0000' + val} else if (val < 100) {val = '000' + val} else if (val < 1000) {val = '00' + val} else if (val < 10000) {val = '0' + val};return val};
                aa = Math.floor (aa%100000); aa = pad (aa);
                ab = Math.floor (ab%100000); ab = pad (ab);
                return c + ad + ' ' + af + ah + ' ' + aa + ' ' + ab;
        };

        const resourceMarkers = {};
        let activeMarkerKey = null;

        const highlightedIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // --- 1. Initialize Map ---
        // Center the map on Finland
        const map = L.map('map').setView([64.0, 26.0], 5);

        // Add the OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- 2. Define Custom Icons ---
        const professionalIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const civilianIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // --- 3. Process and Plot Data ---
        try {
            // Corrected data parsing: Handle the double JSON stringification from Django's json_script
            let professionalData = JSON.parse(JSON.parse(document.getElementById('professional-data').textContent));
            let civilianData = JSON.parse(JSON.parse(document.getElementById('civilian-data').textContent));

            // Plot professional resources (blue markers)
            for (const resource of professionalData) {
                const name = resource.fields.name
                const resource_type = resource.fields.profession
                const specialty = resource.fields.specialty
                const latitude = resource.fields.latitude
                const longitude = resource.fields.longitude
                const pk = resource.pk; // Get Primary Key
                const fields = resource.fields;
                const mgrs = MGRSString(fields.latitude, fields.longitude);

                const marker = L.marker([latitude, longitude], { icon: professionalIcon })
                    .addTo(map)
                    .bindPopup(`<b>${name} ${resource_type}</b><br>${specialty} </br> MGRS:<b> ${mgrs}</b>`);
                // Store marker object and its default icon using the key 'prof-PK'
                resourceMarkers[`prof-${pk}`] = { marker: marker, defaultIcon: professionalIcon };
            }

            // Plot civilian resources (green markers)
            for (const resource of civilianData) {
                const contact_person = resource.fields.contact_person
                const resource_type = resource.fields.resource_type
                const description = resource.fields.description
                const quantity = resource.fields.quantity
                const latitude = resource.fields.latitude
                const longitude = resource.fields.longitude
                const pk = resource.pk; // Get Primary Key
                const fields = resource.fields;
                const mgrs = MGRSString(fields.latitude, fields.longitude);

                const marker = L.marker([latitude, longitude], { icon: civilianIcon })
                    .addTo(map)
                    .bindPopup(`<b>${resource_type} from ${contact_person}</b><br>${description}<br>Quantity: ${quantity}</br> MGRS:<b> ${mgrs}</b>`);
                
                // Store marker object and its default icon using the key 'civil-PK'
                resourceMarkers[`civil-${pk}`] = { marker: marker, defaultIcon: civilianIcon };
            }

        } catch (error) {
            console.error("Error processing map data:", error);
        }

        // --- 4. Event Listener for Table Clicks (NEW LOGIC) ---
        document.addEventListener('click', (event) => {
            const row = event.target.closest('.resource-row');
            if (row) {
                const type = row.dataset.type;
                const id = row.dataset.id;
                const markerKey = `${type}-${id}`;
                const resourceInfo = resourceMarkers[markerKey];

                document.getElementById('map').scrollIntoView();

                if (activeMarkerKey && activeMarkerKey !== markerKey) {
                    const prevResource = resourceMarkers[activeMarkerKey];
                    if (prevResource) prevResource.marker.setIcon(prevResource.defaultIcon);
                    const prevRow = document.querySelector(
                        `.resource-row[data-id="${activeMarkerKey.split('-')[1]}"][data-type="${activeMarkerKey.split('-')[0]}"]`
                    );
                    if (prevRow) prevRow.classList.remove('highlighted-row');
                }

                if (resourceInfo) {
                    resourceInfo.marker.setIcon(highlightedIcon);
                    map.flyTo(resourceInfo.marker.getLatLng(), Math.max(map.getZoom(), 8));
                    resourceInfo.marker.openPopup();
                    row.classList.add('highlighted-row');
                }

                activeMarkerKey = markerKey;
            }
        }); // <--- CLOSE THIS EVENT LISTENER FIRST



        // ----------------------------------------------------------------------
        // --- 5. Click-to-drop movable pin with popup radius input & filtering ---
        // ----------------------------------------------------------------------

        let searchMarker = null;
        let searchCircle = null;

        map.on('click', function (e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            if (searchCircle) {
                map.removeLayer(searchCircle);
                searchCircle = null;
            }

            if (!searchMarker) {
                searchMarker = L.marker([lat, lng], { draggable: false, icon: highlightedIcon }).addTo(map);
            } else {
                searchMarker.setLatLng([lat, lng]);
            }

            const popupContent = `
                <div style="font-size: 14px;">
                    <label>Radius (km):</label><br>
                    <input type="number" id="radius-input" min="0.1" step="0.1"
                        style="width: 80px; padding: 2px; border: 1px solid #ccc; border-radius: 4px;"><br>
                    <button id="radius-submit"
                            style="margin-top: 4px; background-color: #2563eb; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer;">
                        Apply
                    </button>
                </div>
            `;

            searchMarker.bindPopup(popupContent).openPopup();

            setTimeout(() => {
                const button = document.getElementById('radius-submit');
                if (!button) return;

                button.addEventListener('click', () => {
                    const radiusKm = parseFloat(document.getElementById('radius-input').value);
                    if (isNaN(radiusKm) || radiusKm <= 0) {
                        alert("Invalid radius.");
                        return;
                    }
                    const radiusMeters = radiusKm * 1000;

                    if (searchCircle) map.removeLayer(searchCircle);

                    searchCircle = L.circle(searchMarker.getLatLng(), {
                        radius: radiusMeters,
                        color: 'red',
                        fillOpacity: 0.05,
                        weight: 1.5,
                        dashArray: '5, 5'
                    }).addTo(map);

                    const inside = new Set();
                    for (const [key, entry] of Object.entries(resourceMarkers)) {
                        const marker = entry.marker;
                        const dist = map.distance(searchMarker.getLatLng(), marker.getLatLng());
                        if (dist <= radiusMeters) inside.add(key);
                    }

                    document.querySelectorAll('.resource-row').forEach(row => {
                        const type = row.dataset.type;
                        const id = row.dataset.id;
                        const key = `${type}-${id}`;
                        row.style.display = inside.has(key) ? '' : 'none';
                    });

                    if (inside.size === 0) {
                        alert("No resources or skillsets found within that radius.");
                    }

                    map.flyTo(searchMarker.getLatLng(), Math.max(map.getZoom(), 7));
                    searchMarker.closePopup();
                });
            }, 100);
        });

        // final
    </script>
</body>
</html>

    </script>
</body>
</html>
